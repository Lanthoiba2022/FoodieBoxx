<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Form</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .carousel-item img {
      width: 100%;
      height: 600px; /* Increased height */
      object-fit: cover;
    }
    .carousel-inner {
      height: 600px; /* Match height of images */
    }
    .order-container {
      max-width: 600px;
      margin: 0 auto;
    }
    .cart {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      display: none; /* Initially hidden */
      z-index: 1000; /* Ensure it stays above other elements */
    }
    .cart-icon {
      font-size: 24px;
      cursor: pointer;
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      z-index: 1001; /* Ensure it stays above other elements */
    }

    .cart-image {
      width: 32px; /* Set this to the size you want the image to be */
      height: 32px; /* Ensures the image is square and matches the icon size */
      object-fit: contain; /* Keeps the aspect ratio of the image */
      margin-left: 5px; /* Optional: Adds some space between the icon and the image */
    }
    .cart-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none; /* Initially hidden */
      z-index: 999; /* Ensure it covers the screen */
    }
    .cart-item-buttons {
      display: flex;
      align-items: center;
    }
    .cart-item-buttons button {
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">FoodieBoxx</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Cart Icon -->
    <div class="cart-icon">
      <i class="fas fa-shopping-cart"></i>
      <span id="cartCount" class="badge badge-pill badge-danger">0</span>
      <img src="https://t3.ftcdn.net/jpg/03/14/84/68/360_F_314846831_5jJsC7Us9obgwMjRDqFhs04dodzvnZvi.jpg" alt="Cart Icon" class="cart-image">
    </div>
  </nav>

  <!-- Carousel -->
  <div id="foodCarousel" class="carousel slide mt-4" data-ride="carousel">
    <ol class="carousel-indicators">
      <li data-target="#foodCarousel" data-slide-to="0" class="active"></li>
      <li data-target="#foodCarousel" data-slide-to="1"></li>
      <li data-target="#foodCarousel" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="https://images.pexels.com/photos/2909821/pexels-photo-2909821.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Food Image 1" />
      </div>
      <div class="carousel-item">
        <img src="https://images.pexels.com/photos/6004758/pexels-photo-6004758.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Food Image 2" />
      </div>
      <div class="carousel-item">
        <img src="https://images.pexels.com/photos/4877863/pexels-photo-4877863.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Food Image 3" />
      </div>
    </div>
    <a class="carousel-control-prev" href="#foodCarousel" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#foodCarousel" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>

  <!-- Available Dishes -->
  <div class="container mt-5">
    <h2 class="text-center">Available Dishes</h2>
    <div class="row">
      {% for dish in dishes %}
      <div class="col-md-4">
        <div class="card mb-3">
          <img src="{{ dish.image }}" class="card-img-top" alt="Dish" />
          <div class="card-body">
            <h5 class="card-title">{{ dish.name }}</h5>
            <p class="card-text">${{ dish.price }}</p>
            <button type="button" class="btn btn-primary add-to-cart" data-item-id="{{ dish.id }}" data-item-name="{{ dish.name }}" data-item-price="{{ dish.price }}">
              Add to Cart
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Cart -->
  <div class="cart-backdrop" id="cartBackdrop"></div>
  <div class="cart" id="cart">
    <h5>Cart</h5>
    <div id="cartItems"></div>
    <button id="submitOrder" class="btn btn-success mt-3">Submit Order</button>
  </div>

  <!-- Bootstrap JS and dependencies -->
  <!-- jQuery (full version) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script> <!-- Font Awesome for icons -->


  <script>
    let cart = [];

    // Function to update the cart display
    function updateCartDisplay() {
      const cartItemsContainer = $('#cartItems');
      cartItemsContainer.empty();

      let totalItems = 0;

      if (cart.length === 0) {
        cartItemsContainer.html('<p>Your cart is empty</p>');
        $('#submitOrder').prop('disabled', true);
      } else {
        cart.forEach(item => {
          totalItems += item.quantity; // Sum up all item quantities

          cartItemsContainer.append(`
            <div class="cart-item">
              <p>${item.name} - $${item.price} x ${item.quantity}</p>
              <div class="cart-item-buttons">
                <button class="btn btn-danger btn-sm remove-from-cart" data-item-id="${item.id}">Remove</button>
                <button class="btn btn-secondary btn-sm decrease-quantity" data-item-id="${item.id}">-</button>
                <button class="btn btn-secondary btn-sm increase-quantity" data-item-id="${item.id}">+</button>
              </div>
            </div>
          `);
        });
        $('#submitOrder').prop('disabled', false);
      }

      // Update cart count in the cart icon
      $('#cartCount').text(totalItems); // Display total items count
    }

    // Handle adding items to the cart
    $('.add-to-cart').click(function () {
      const itemId = $(this).data('item-id');
      const itemName = $(this).data('item-name');
      const itemPrice = $(this).data('item-price');

      const existingItem = cart.find(item => item.id === itemId);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({ id: itemId, name: itemName, price: itemPrice, quantity: 1 });
      }

      updateCartDisplay();
    });

    // Handle removing items from the cart
    $(document).on('click', '.remove-from-cart', function () {
      const itemId = $(this).data('item-id');
      cart = cart.filter(item => item.id !== itemId);
      updateCartDisplay();
    });

    // Handle decreasing item quantity
    $(document).on('click', '.decrease-quantity', function () {
      const itemId = $(this).data('item-id');
      const item = cart.find(item => item.id === itemId);
      if (item) {
        item.quantity--;
        if (item.quantity <= 0) {
          cart = cart.filter(i => i.id !== itemId);
        }
        updateCartDisplay();
      }
    });

    // Handle increasing item quantity
    $(document).on('click', '.increase-quantity', function () {
      const itemId = $(this).data('item-id');
      const item = cart.find(item => item.id === itemId);
      if (item) {
        item.quantity++;
        updateCartDisplay();
      }
    });

    // Show/hide cart and backdrop
    $('.cart-icon').click(function () {
      $('#cart').toggle();
      $('#cartBackdrop').toggle();
    });

    $('#cartBackdrop').click(function () {
      $('#cart').hide();
      $('#cartBackdrop').hide();
    });

    // Handle form submission
    $('#submitOrder').click(function () {
  if (cart.length === 0) {
    alert('Your cart is empty!');
    return;
  }

  const cartItems = cart.map(item => ({
    id: item.id,
    quantity: item.quantity
  }));

  $.ajax({
    url: '/submit_order/',
    method: 'POST',
    data: {
      'cart_items': JSON.stringify(cartItems),
      'csrfmiddlewaretoken': '{{ csrf_token }}'  // Ensure CSRF token is included
    },
    success: function (response) {
      window.location.href = response.session_url;  // Redirect to Stripe Checkout
    },
    error: function () {
      alert('An error occurred. Please try again.');
    }
  });
});
  </script>
</body>
</html>
